<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - OMSUT</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-image: linear-gradient(rgba(11,16,32,0.55), rgba(11,16,32,0.55)), url("assets/bg.jpg");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #f5f5f5;
      min-height: 100vh;
      padding: 80px 20px 20px 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 40px; }
    h1 { font-size: 2.5em; margin-bottom: 10px; color: #ff6b6b; }
    .message { text-align: center; color: #ff6b6b; padding: 15px; font-size: 1.1em; margin-bottom: 20px; }
    .admin-section { background: rgba(255, 255, 255, 0.05); border: 1px solid #ff6b6b; border-radius: 10px; padding: 25px; margin-bottom: 30px; }
    .admin-section h2 { color: #ff6b6b; margin-bottom: 20px; font-size: 1.5em; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select { 
      width: 100%; 
      padding: 10px; 
      background: rgba(255, 255, 255, 0.1); 
      border: 1px solid #ff6b6b; 
      border-radius: 5px;
      color: #f5f5f5;
      font-size: 1em;
    }
    input::placeholder { color: #999; }
    .btn { 
      padding: 12px 24px; 
      background: #ff6b6b; 
      color: #fff; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      font-weight: bold;
      font-size: 1em;
      transition: all 0.3s ease;
      margin-right: 10px;
    }
    .btn:hover { background: #ff5252; transform: scale(1.05); }
    .btn-secondary { background: #666; color: #f5f5f5; }
    .btn-secondary:hover { background: #777; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #ff6b6b;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-value { font-size: 2.5em; font-weight: bold; color: #ff6b6b; margin-bottom: 10px; }
    .stat-label { color: #999; font-size: 0.9em; text-transform: uppercase; }
    .users-list, .badges-list { max-height: 400px; overflow-y: auto; }
    .user-row, .badge-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      gap: 10px;
    }
    .user-row:last-child, .badge-row:last-child { border-bottom: none; }
    .user-row:hover, .badge-row:hover { background: rgba(255, 255, 255, 0.05); }
    .user-info { flex: 1; }
    .user-info strong { color: #ff6b6b; }
    .nav-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap; }
    .loading { text-align: center; color: #999; font-size: 1.2em; }
    @media (max-width: 768px) {
      h1 { font-size: 2em; }
      .admin-section { padding: 15px; }
      .user-row, .badge-row { flex-direction: column; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <a href="home.html" class="navbar-brand">üè† OMSUT</a>
      <div class="navbar-menu">
        <div id="user-profile" style="display: none;">
          <img id="profile-photo-small" src="" alt="Photo" />
          <span id="profile-name-small"></span>
          <a id="profile-link" href="profile.html" class="navbar-link">Profil</a>
          <a id="stats-link" href="stats.html" class="navbar-link">Stats</a>
          <a id="leaderboard-link" href="leaderboard.html" class="navbar-link">Classement</a>
          <button id="logout-btn" class="navbar-btn">D√©connecter</button>
        </div>
        <a id="login-link" href="auth-keycloak.html" class="navbar-btn" style="display:inline-block;">Se connecter</a>
      </div>
    </div>
  </nav>
  <div class="container">
    <header>
      <h1>‚öôÔ∏è Admin Panel</h1>
      <p style="color: #999; margin-top: 10px;">G√©rer les utilisateurs et les badges</p>
    </header>

    <div id="message" class="message" style="display:none;"></div>

    <!-- Global Stats -->
    <div class="admin-section">
      <h2>üìä Statistiques Globales</h2>
      <div id="stats-container" class="stats-grid">
        <div class="loading">Chargement...</div>
      </div>
    </div>

    <!-- Award Badge -->
    <div class="admin-section">
      <h2>üéñÔ∏è Attribuer un Badge</h2>
      <div class="form-group">
        <label for="target-username">Pseudo du joueur</label>
        <input id="target-username" type="text" placeholder="Ex: alice123" />
      </div>
      <div class="form-group">
        <label for="badge-select">Badge</label>
        <select id="badge-select">
          <option value="">-- S√©lectionner un badge --</option>
        </select>
      </div>
      <button class="btn" onclick="awardBadge()">Attribuer le badge</button>
    </div>

    <!-- Users List -->
    <div class="admin-section">
      <h2>üë• Liste des Utilisateurs</h2>
      <div class="users-list" id="users-container">
        <div class="loading">Chargement des utilisateurs...</div>
      </div>
    </div>

    <!-- Badges Management -->
    <div class="admin-section">
      <h2>üèÖ Badges Disponibles</h2>
      <div class="form-group">
        <label for="new-badge-name">Nom du badge</label>
        <input id="new-badge-name" type="text" placeholder="Ex: Super Champion" />
      </div>
      <div class="form-group">
        <label for="new-badge-desc">Description</label>
        <input id="new-badge-desc" type="text" placeholder="Ex: 10 victoires cons√©cutives" />
      </div>
      <button class="btn" onclick="createBadge()">Cr√©er un badge</button>
      <div class="badges-list" id="badges-container" style="margin-top: 20px;">
        <div class="loading">Chargement des badges...</div>
      </div>
    </div>

    <div class="nav-buttons">
      <button class="btn btn-secondary" onclick="window.location.href='index.html'">‚Üê Retour au jeu</button>
      <button class="btn btn-secondary" onclick="logout()">D√©connexion</button>
    </div>
  </div>

  <script src="auth-helper.js"></script>
  <script>
    const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const API_BASE = isLocal ? `${window.location.protocol}//localhost:3000` : 'https://omsut.fun';

    function getToken() {
      return localStorage.getItem('omsut_token');
    }

    async function checkAdmin() {
      const token = getToken();
      if (!token) {
        showMessage('Vous devez √™tre connect√©.', true);
        setTimeout(() => window.location.href = 'auth.html', 2000);
        return false;
      }

      try {
        const res = await fetch(API_BASE + '/api/profile', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Unauthorized');
        
        const user = await res.json();
        if (!user.isAdmin) {
          showMessage('Acc√®s refus√© : vous n\'√™tes pas administrateur', true);
          setTimeout(() => window.location.href = 'index.html', 2000);
          return false;
        }
        return true;
      } catch (err) {
        console.error(err);
        showMessage('Erreur de v√©rification', true);
        return false;
      }
    }

    async function loadStats() {
      try {
        const res = await fetch(API_BASE + '/api/stats');
        if (!res.ok) throw new Error('Failed');
        const stats = await res.json();

        const html = `
          <div class="stat-card">
            <div class="stat-value">${stats.total_users || 0}</div>
            <div class="stat-label">Utilisateurs</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${stats.total_games || 0}</div>
            <div class="stat-label">Parties Jou√©es</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${stats.total_wins || 0}</div>
            <div class="stat-label">Victoires Totales</div>
          </div>
        `;
        document.getElementById('stats-container').innerHTML = html;
      } catch (err) {
        console.error(err);
      }
    }

    async function loadBadges() {
      try {
        const res = await fetch(API_BASE + '/api/badges');
        if (!res.ok) throw new Error('Failed');
        const badges = await res.json();

        const select = document.getElementById('badge-select');
        select.innerHTML = '<option value="">-- S√©lectionner un badge --</option>';
        badges.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b.id;
          opt.textContent = `${b.name} ‚Äî ${b.description || ''}`;
          select.appendChild(opt);
        });

        const html = badges.map(b => `
          <div class="badge-row">
            <div><strong>${b.name}</strong> ‚Äî ${b.description || 'N/A'}</div>
            <div><small style="color:#999;">ID: ${b.id}</small></div>
          </div>
        `).join('');
        document.getElementById('badges-container').innerHTML = html || '<div style="text-align:center;color:#999;">Aucun badge</div>';
      } catch (err) {
        console.error(err);
      }
    }

    async function awardBadge() {
      const username = document.getElementById('target-username').value.trim();
      const badgeId = document.getElementById('badge-select').value;
      const token = getToken();

      if (!username) return showMessage('Indiquez un pseudo', true);
      if (!badgeId) return showMessage('S√©lectionnez un badge', true);

      try {
        // Find user by username
        const userRes = await fetch(API_BASE + '/api/users/by-username?username=' + encodeURIComponent(username));
        if (!userRes.ok) throw new Error('User not found');
        const user = await userRes.json();

        // Award badge
        const awardRes = await fetch(API_BASE + `/api/users/${user.id}/badges/${badgeId}`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (!awardRes.ok) {
          const err = await awardRes.json();
          return showMessage(err.error || 'Erreur', true);
        }

        showMessage(`Badge attribu√© √† ${username}`);
        document.getElementById('target-username').value = '';
        document.getElementById('badge-select').value = '';
      } catch (err) {
        console.error(err);
        showMessage('Erreur : ' + err.message, true);
      }
    }

    async function createBadge() {
      const name = document.getElementById('new-badge-name').value.trim();
      const desc = document.getElementById('new-badge-desc').value.trim();
      const token = getToken();

      if (!name) return showMessage('Indiquez un nom', true);

      try {
        // This endpoint doesn't exist yet; in a real system you'd implement it
        showMessage('Cr√©ation de badge non disponible via UI - utilisez le backend directement', true);
      } catch (err) {
        console.error(err);
      }
    }

    function showMessage(text, isError = false) {
      const el = document.getElementById('message');
      el.textContent = text;
      el.style.color = isError ? '#ff6b6b' : '#4ecdc4';
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    }

    async function logout() {
      localStorage.removeItem('omsut_token');
      
      try {
        const res = await fetch(API_BASE + '/api/auth/keycloak/config');
        const keycloakConfig = await res.json();
        
        if (keycloakConfig && keycloakConfig.url) {
          const logoutUrl = `${keycloakConfig.url}realms/${keycloakConfig.realm}/protocol/openid-connect/logout`;
          const redirectUri = encodeURIComponent(window.location.origin + '/auth-keycloak.html');
          window.location.href = `${logoutUrl}?redirect_uri=${redirectUri}`;
        } else {
          window.location.href = 'auth-keycloak.html';
        }
      } catch (err) {
        window.location.href = 'auth-keycloak.html';
      }
    }

    // Initialize
    (async () => {
      const isAdmin = await checkAdmin();
      if (isAdmin) {
        await loadStats();
        await loadBadges();
        await loadUsers();
      }
    })();

    async function loadUsers() {
      const token = getToken();
      try {
        const res = await fetch(API_BASE + '/api/admin/users', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Failed');
        const users = await res.json();

        const html = users.map(u => `
          <div class="user-row">
            <div class="user-info">
              <div><strong>${u.display_name || u.username}</strong></div>
              <div style="font-size:0.9em;color:#999;">@${u.username}</div>
              <div style="font-size:0.85em;color:#999;">Badges: ${u.badge_count}, Victoires: ${u.wins || 0}</div>
            </div>
            <div style="text-align:right;font-size:0.9em;color:#999;">${new Date(u.created_at).toLocaleDateString()}</div>
          </div>
        `).join('');
        
        document.getElementById('users-container').innerHTML = html || '<div style="text-align:center;color:#999;">Aucun utilisateur</div>';
      } catch (err) {
        console.error(err);
        document.getElementById('users-container').innerHTML = '<div style="color:#ff6b6b;text-align:center;">Erreur</div>';
      }
    }
  </script>
</body>
</html>
